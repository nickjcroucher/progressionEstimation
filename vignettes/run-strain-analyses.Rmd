---
title: "Analysis of invasiveness in *S. pneumoniae* using strain and serotype information"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{run-strain-analyses}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(rmarkdown.html_vignette.check_title = FALSE)
```

```{r setup}
# Load dependencies
require(tidyverse)
require(magrittr)
require(rstan)
require(bridgesampling)
require(loo)
require(cowplot)
require(ggrepel)
require(xlsx)

# Load stan package
library(progressionEstimation)
pkgbuild::compile_dll()
roxygen2::roxygenize(package.dir = "..")
```

This analysis will combine both information on *S. pneumoniae* isolates' serotype and strain background, using the strain definitions generated by [PopPUNK](https://github.com/johnlees/PopPUNK) described by the [Global Pneumococcal Sequencing project](pneumogen.net). These analyses requires a different input, which specifies both the strains of the isolates, and a second classification in the `categorisation` column of the input spreadsheet. These data can be loaded using `use_strain = TRUE`:

```{r Read spreadsheet}

s_pneumoniae_strains_df <-
  progressionEstimation::process_input_xlsx("s_pneumoniae_strains_sweden.xlsx",
                                            use_strain = TRUE)

```

The strain data can be loaded in four ways:

* by serotype - using the default `process_input_data` command

* by strain - by specifying that the `subtype` to be used is the `strain` column, rather than the `categorisation` column

* by serotype and strain - by using the `categorisation` column as the subtype and additionally specifying `use_strain = TRUE`, the population will be classified by separately by the two categories, serotype and strain

* combining serotype and strain - by using the `categorisation` column as the subtype and additionally specifying `combine_strain = TRUE`, the population will be divided based on the combination of strain and serotype (i.e. there is no relationship between isolates unless they share both serotype and strain)

These processing commands also specify `condense = FALSE` (the default for the function). This means that the division of the population will replicate that in the rows of the input data. This is necessary for comparing models where progression rates are determined by different characteristics, because cross-validation requires the same number of data points in each compared model. However, `condense = TRUE` will collapse all entries for the same categorisation; e.g. if `subtype = 'serotype'`, then all duplicated entries of serotype belonging to the same study would be combined into a single entry. This would be necessary if appending this dataset to a wider dataset in which only serotype, and not strain, were known.

```{r Process data frame}

# Load data by serotype
s_pneumoniae_sweden_by_serotype_data <-
  progressionEstimation::process_input_data(s_pneumoniae_strains_df,
                                            condense = FALSE)

# Load data by strain
s_pneumoniae_sweden_by_strain_data <-
  progressionEstimation::process_input_data(s_pneumoniae_strains_df,
                                            subtype = "strain",
                                            condense = FALSE)

# Load data by strain and serotype
s_pneumoniae_sweden_by_serotype_and_strain_data <-
  progressionEstimation::process_input_data(s_pneumoniae_strains_df,
                                            use_strain = TRUE,
                                            condense = FALSE)

# Load data combining strain and serotype
s_pneumoniae_sweden_combine_serotype_and_strain_data <-
  progressionEstimation::process_input_data(s_pneumoniae_strains_df,
                                            combine_strain = TRUE,
                                            condense = FALSE)

```

## Fitting the model

There are then five versions of the same model structure that can be fitted to these data, using the classification of isolates having a serotype $j$ and strain $k$:

* invasiveness is determined by serotype: $\nu_{j}$

* invasiveness is determined by strain: $\nu_{k}$

* invasiveness is primarily determined by serotype, and modified by strain: $\nu_{j}\nu_{k}$

* invasiveness is primarily determined by strain, and modified by serotype: $\nu_{j}\nu_{k}$

* invasiveness differs between each combination of serotype and strain: $\nu_{j,k}$

To fit the model that invasiveness is determined by serotype indepedent of strain, the same approach is used as described in the other vignettes, using the serotype-only data. Not that when processing the output data, we again specify `condense = FALSE`, because the data are kept as separate rows for each serotype-strain combination, even through the strain information is not used in this model fit. Additionally, because we will be fitting multiple type-specific models, with the subtypes differing between them, we will specify a more detailed `model_name`. This enables the models to be distinguished when they are compared.

```{r Fit Poisson model to serotype data}

s_pneumoniae_sweden_by_serotype_fit <- 
  progressionEstimation::fit_progression_rate_model(s_pneumoniae_sweden_by_serotype_data,
                                                    type_specific = TRUE,
                                                    location_adjustment = FALSE,
                                                    model_description = "serotype_type_specific_poisson",
                                                    num_chains = 2,
                                                    num_iter = 1e4)

s_pneumoniae_sweden_serotype_output_df <-
  progressionEstimation::process_progression_rate_model_output(s_pneumoniae_strains_df,
                                                               s_pneumoniae_sweden_by_serotype_fit,
                                                               condense = FALSE)

```

To fit the model that invasiveness is determined by strain indepedent of serotype, this approach is modified to instead use the data in which the categorisation was defined as the strain (note that `subtype = "strain"` must be specified when processing the output, to ensure the invasiveness values correspond to strains, rather than serotypes:

```{r Fit Poisson model to strain data}

s_pneumoniae_sweden_by_strain_fit <- 
  progressionEstimation::fit_progression_rate_model(s_pneumoniae_sweden_by_strain_data,
                                                    type_specific = TRUE,
                                                    location_adjustment = FALSE,
                                                    model_description = "strain_type_specific_poisson",
                                                    num_chains = 2,
                                                    num_iter = 1e4)

s_pneumoniae_sweden_strain_output_df <-
  progressionEstimation::process_progression_rate_model_output(s_pneumoniae_strains_df,
                                                               s_pneumoniae_sweden_by_strain_fit,
                                                               subtype = "strain",
                                                               condense = FALSE)

```

The next two models use the data containing information on both the strains and serotypes. To fit a model in which invasiveness is primarily determined by serotype, but modified by strain, we specify `strain_as_secondary_type = TRUE`:

```{r Fit Poisson model to serotype and strain data 1}

s_pneumoniae_sweden_by_serotype_then_strain_fit <- 
  progressionEstimation::fit_progression_rate_model(s_pneumoniae_sweden_by_serotype_and_strain_data,
                                                    type_specific = TRUE,
                                                    location_adjustment = FALSE,
                                                    strain_as_secondary_type = TRUE,
                                                    model_description = "serotype_then_strain_type_specific_poisson",
                                                    num_chains = 2,
                                                    num_iter = 1e4)

s_pneumoniae_sweden_by_serotype_then_strain_output_df <-
  progressionEstimation::process_progression_rate_model_output(s_pneumoniae_strains_df,
                                                            s_pneumoniae_sweden_by_serotype_then_strain_fit,
                                                               strain_as_secondary_type = TRUE,
                                                               condense = FALSE)
```

The next model is fitted in the same way, except specifying `strain_as_primary_type = TRUE`:

```{r Fit Poisson model to serotype and strain data 2}

s_pneumoniae_sweden_by_strain_then_serotype_fit <- 
  progressionEstimation::fit_progression_rate_model(s_pneumoniae_sweden_by_serotype_and_strain_data,
                                                    type_specific = TRUE,
                                                    location_adjustment = FALSE,
                                                    strain_as_primary_type = TRUE,
                                                    model_description = "strain_then_serotype_type_specific_poisson",
                                                    num_chains = 2,
                                                    num_iter = 1e4)

s_pneumoniae_sweden_by_strain_then_serotype_output_df <-
  progressionEstimation::process_progression_rate_model_output(s_pneumoniae_strains_df,
                                                            s_pneumoniae_sweden_by_strain_then_serotype_fit,
                                                               strain_as_primary_type = TRUE,
                                                               condense = FALSE)

```

The final model fit uses the combined type, defined by the serotype and strain, as a single subtype classification:

```{r Fit Poisson model to serotype and strain data 3}

s_pneumoniae_sweden_combined_strain_serotype_fit <- 
  progressionEstimation::fit_progression_rate_model(s_pneumoniae_sweden_combine_serotype_and_strain_data,
                                                    type_specific = TRUE,
                                                    location_adjustment = FALSE,
                                                    model_description = "combined_serotype_and_strain_type_specific_poisson",
                                                    num_chains = 2,
                                                    num_iter = 1e4)

s_pneumoniae_sweden_combined_strain_serotype_output_df <-
  progressionEstimation::process_progression_rate_model_output(s_pneumoniae_strains_df,
                                                            s_pneumoniae_sweden_combined_strain_serotype_fit,
                                                            combined_strain_subtype = TRUE,
                                                               condense = FALSE)

```

## Plotting the results

We can then plot the estimated progression rates when the population was divided by serotype only:

``` {r Plot progression rate estimates for serotypes}

progressionEstimation::plot_progression_rates(s_pneumoniae_sweden_serotype_output_df,
                                              unit_time = "year",
                                              type_name = "Serotypes")

```

The most invasive serotypes are 1, 7F and 14. We can generate a similar plot based on the fit to the same population, this time divided by strains, if we specify the correct `subtype` argument (if the incorrect argument is specified, there will be multiple data points per category on the x axis).

``` {r Plot progression rate estimates for strains}

progressionEstimation::plot_progression_rates(s_pneumoniae_sweden_strain_output_df,
                                              subtype = "strain",
                                              unit_time = "year",
                                              type_name = "Strain")

```

This plot shows strains 15, 18 and 31 are the most invasive. These outputs can now be compared to those from models in which both serotype and strain can contribute to the progression rate. For the first model, in which invasiveness is primarily determined by serotype and modified by invasiveness, we start by plotting the contribution of serotype to invasiveness:

``` {r Plot progression rate estimates for serotype modified by strain - plotted by serotype}

progressionEstimation::plot_progression_rates(s_pneumoniae_sweden_by_serotype_then_strain_output_df,
                                              unit_time = "year",
                                              type_name = "Serotype")

```

In this plot, serotypes 1, 7F and 14 still have the highest upper bounds, but all the progression rate credibility intervals are wide. These models, with two contributing factors to the progression rate, require more data to infer the contributions of each. We can then plot the inferred contribution of the strain background to invasiveness:

``` {r Plot progression rate estimates for serotype modified by strain - plotted by strain}

progressionEstimation::plot_progression_rates(s_pneumoniae_sweden_by_serotype_then_strain_output_df,
                                              subtype = "strain",
                                              unit_time = "year",
                                              type_name = "Strain")

```

These vales are progression rate modifiers, relative to the contribution from serotype, rather than absolute progression rates themselves (i.e. the overall invasiveness is determined by $\nu_{j}\nu_{k}$; if $\nu_{k}$ ~ 1, then the overall invasiveness is $\approx\nu_{j}$). The progression rate modifiers all span one, the value at which he strain makes no contribution to invasiveness. However, there is some evidence of elevated invasivness associated with strains 15, 18 and 31, as before.

Analogous plots can be generated for the similar model in which invasiveness is determined primarily by strain, then modified by serotype. The contribution of strains can be plotted as above, but now more closely resemble the numerical values in the strain-only version:

``` {r Plot progression rate estimates for strain modified by serotype - plotted by strain}

progressionEstimation::plot_progression_rates(s_pneumoniae_sweden_by_strain_then_serotype_output_df,
                                              subtype = "strain",
                                              unit_time = "year",
                                              type_name = "Strain")

```

Similarly, the contribution of serotype can be plotted; these values are now modifiers of invasiveness, which is primarily determined by strain. Hence the serotype contributions generally span 1, the value at which they do not alter the strain-determined invasiveness:

``` {r Plot progression rate estimates for strain modified by serotype - plotted by serotype}

progressionEstimation::plot_progression_rates(s_pneumoniae_sweden_by_strain_then_serotype_output_df,
                                              unit_time = "year",
                                              type_name = "Serotype")

```

Finally, we can plot the progression rates associated with the individual combinations of strain and serotype. Here, we see the close association between the most invasive serotypes (1, 7F and 14) and the most invasive strains (15, 18 and 31). This linkage disequilibrium makes it difficult to disentangle the contributions of the two categorisations. This requires information on serotypes shared between multiple strains, as observed for serotypes 6A and 19F.

``` {r Plot progression rate estimates for serotype_strain combinations}

progressionEstimation::plot_progression_rates(s_pneumoniae_sweden_combined_strain_serotype_output_df,
                                              subtype = "combined",
                                              unit_time = "year",
                                              type_name = "Serotype_strain combination")

```

## Run model comparisons

To establish which model best captures the heterogeneity in progression rates across the bacterial population, the can be compated with LOO-CV.

``` {r Compare models with LOO-CV}

model_list <- list(s_pneumoniae_sweden_by_serotype_fit,
                   s_pneumoniae_sweden_by_strain_fit,
                   s_pneumoniae_sweden_by_strain_then_serotype_fit,
                   s_pneumoniae_sweden_by_serotype_then_strain_fit,
                   s_pneumoniae_sweden_combined_strain_serotype_fit)

progressionEstimation::compare_model_fits_with_loo(model_list) %>%
  kableExtra::kable()  %>%
  kableExtra::kable_styling(latex_options = "scale_down")

```

These results show the four-best fitting models all perform similarly well - the `elpd_diff` values are below four and similar in magnitude to the to `se_diff` values, so there is little substantial difference between them. The only model that significantly underperforms is the `serotype_then_strain_type_specific_poisson`. The poor fit of this model suggests the heterogeneity in progression rates across the species are poorly described by .

The models can also be compared using Bayes' factors:

``` {r Compare models with Bayes factors}

progressionEstimation::compare_model_fits_with_bf(model_list) %>%
  dplyr::rename(`log(Bayes factor)` = log_Bayes_factor) %>%
  kableExtra::kable()  %>%
  kableExtra::kable_styling(latex_options = "scale_down")

```
These results agree that the `strain_type_specific_poisson` and `combined_serotype_and_strain_type_specific_poisson` models are the best-performing with this dataset. The `strain_then_serotype_type_specific_poisson` and `serotype_then_strain_type_specific_poisson` models both perform similarly poorly. This likely reflects them having the same set of prior distributions, which are distinct from those of the other models, as prior distributions do not affect the LOO-CV comparison. The Bayes factor analysis suggests classification by strain is a better approach to analysing progression rates than classification by serotype.
