---
title: "*S. pneumoniae* strain invasiveness"
output: rmarkdown::html_vignette
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 8,
  comment = "#>"
)
```

```{r setup, include = FALSE}
# Load dependencies
require(tidyverse)
require(magrittr)
require(rstan)
require(bridgesampling)
require(loo)
require(cowplot)
require(ggrepel)
require(xlsx)
require(gtools)
# Load stan package
library(progressionEstimation)
#pkgbuild::compile_dll()
#roxygen2::roxygenize(package.dir = "..")

#############
# Functions #
#############

plot_progression_rate_by_type <- function(model_output_df,
                                          type = "type",
                                          unit_time = "unit time",
                                          type_name = "type",
                                          colour_col = NULL,
                                          colour_palette = NULL,
                                          use_sample_size = FALSE) {
  if (!(any(grepl("nu",colnames(model_output_df))))) {
    stop("Need to include model output in data frame for plotting")
  }
  progression_rate_values <- c("nu", "nu_lower", "nu_upper")
  if (type == "strain") {
    progression_rate_values <- paste0("secondary_", progression_rate_values)
  }
  y_label_text = paste0("Progression rate contribution (disease per carrier per ",unit_time,")")

  model_output_df %<>%
      dplyr::group_by(!!! dplyr::syms(type)) %>%
      dplyr::mutate(num_observations = sum(carriage+disease)) %>%
      dplyr::ungroup()

  if (type == "type") {
    model_output_df %<>%
      dplyr::group_by(!!! dplyr::syms(type),strain) %>%
      dplyr::slice_head(n=1) %>%
      dplyr::ungroup()
  } else if (type == "strain") {
    model_output_df %<>%
      dplyr::group_by(!!! dplyr::syms(type),type) %>%
      dplyr::slice_head(n=1) %>%
      dplyr::ungroup()
  }

  if (is.null(colour_col)) {
    if (use_sample_size) {
      base_graph <-
        ggplot(model_output_df,
               aes(x = get(!!type),
                   y = get(progression_rate_values[1]),
                   ymin = get(progression_rate_values[2]),
                   ymax = get(progression_rate_values[3]),
                   shape = num_observations))
    } else {
      base_graph <-
        ggplot(model_output_df,
               aes(x = get(!!type),
                   y = get(progression_rate_values[1]),
                   ymin = get(progression_rate_values[2]),
                   ymax = get(progression_rate_values[3])))
    }
  } else {
    if (use_sample_size) {
      base_graph <-
        ggplot(model_output_df,
               aes(x = get(!!type),
                   y = get(progression_rate_values[1]),
                   ymin = get(progression_rate_values[2]),
                   ymax = get(progression_rate_values[3]),
                   colour = get(colour_col),
                   fill = get(colour_col),
                   shape = num_observations))
    } else {
      base_graph <-
        ggplot(model_output_df,
               aes(x = get(!!type),
                   y = get(progression_rate_values[1]),
                   ymin = get(progression_rate_values[2]),
                   ymax = get(progression_rate_values[3]),
                   colour = get(colour_col),
                   fill = get(colour_col)))
    }
  }

  point_graph <-
    base_graph +
    geom_point() +
    geom_errorbar() +
    ylab(y_label_text) +
    xlab(type_name) +
    scale_y_continuous(trans ="log10") +
    theme_bw()

  if (!is.null(colour_col) & !is.null(colour_palette)) {
    point_graph <- point_graph +
      scale_colour_manual(values = colour_palette,
                          name = colour_col) +
      scale_fill_manual(values = colour_palette,
                        name = colour_col) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
            legend.position = "bottom")
  } else if (!is.null(colour_col)) {
    point_graph <- point_graph +
      theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
            legend.position = "bottom")
  } else {
    point_graph <- point_graph +
      theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  }

  if (use_sample_size) {
    point_graph <- point_graph +
      scale_shape_binned(name = "Number of\nisolates",
                         breaks = c(5,10,25,50,100))
  }

  return(point_graph)
}

###################
# Data structures #
###################

# Define serotype categories and palettes
vaccine_types <- list(
  "PCV7" = c("4","6B","9V","14","18C","19F","23F"),
  "PCV10" = c("1","5","7F"),
  "PCV13" = c("6A","3","19A"),
  "PCV15" = c("22F","33F"),
  "PCV20" = c("8","10A","11A","12F","15B/C"),
  "PPV23" = c("2","9N","17F","20")
)

vaccine_colours <- c("No PCV" = "blue",
                     "PCV7" = "red",
                     "PCV10" = "orange",
                     "PCV13" = "coral2",
                     "PCV15" = "pink",
                     "PCV20" = "purple",
                     "PPV23" = "black")

epi_colors <- c(
  "carriage" = "skyblue",
  "disease" = "cornflowerblue"
)

model_name_labels <-
  c(
    "type-specific Poisson",
    "type-specific negative binomial",
    "strain-specific Poisson",
    "strain-specific negative binomial",
    "type-specific strain-modified Poisson",
    "type-specific strain-modified negative binomial",
    "strain-specific type-modified Poisson",
    "strain-specific type-modified negative binomial",
    "strain- and type-specific Poisson",
    "strain- and type-specific negative binomial"
  )

```

## Description and filtering of the dataset

The dataset used in this analysis is contained in the `S_pneumoniae_infant_strain` object, which includes data from `r S_pneumoniae_infant_strain %>% dplyr::select(study) %>% dplyr::n_distinct()` studies on `r S_pneumoniae_infant_strain %>% dplyr::select(type) %>% dplyr::n_distinct()` serotypes. The distribution of samples between each study can be plotted, if they are ranked by the mean number of carriage and disease isolates:

``` {r Plot distribution by study, include = FALSE}

studies_by_size <-
  S_pneumoniae_infant_strain %>%
    group_by(study) %>%
    dplyr::mutate(total_count = sum(carriage)+sum(disease)) %>%
    dplyr::select(study,total_count) %>%
    dplyr::distinct() %>%
    dplyr::arrange(desc(total_count)) %>%
    dplyr::select(study) %>%
    dplyr::pull()

S_pneumoniae_infant_strain %<>%
  dplyr::mutate(study = factor(study, levels = studies_by_size))

(full_epi_data_plot <-
  ggplot(S_pneumoniae_infant_strain %>%
           tidyr::pivot_longer(c(carriage,disease),
                               names_to = "Sample type",
                               values_to = "count"),
         aes(x = study,
             y = count,
             colour = `Sample type`,
             fill = `Sample type`)) +
    geom_col() +
    theme_bw() + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    scale_fill_manual(values = epi_colors) +
    scale_colour_manual(values = epi_colors)
)
```

The total number of observations for each serotype can be similarly plotted:

``` {r Plot distribution by serotype, include = FALSE}

serotype_by_count <-
  S_pneumoniae_infant_strain %>%
    group_by(type) %>%
    dplyr::mutate(total_count = sum(carriage)+sum(disease)) %>%
    dplyr::select(type,total_count) %>%
    dplyr::distinct() %>%
    dplyr::arrange(desc(total_count)) %>%
    dplyr::select(type) %>%
    dplyr::pull()

strain_by_count <-
  S_pneumoniae_infant_strain %>%
    group_by(strain) %>%
    dplyr::mutate(total_count = sum(carriage)+sum(disease)) %>%
    dplyr::select(strain,total_count) %>%
    dplyr::distinct() %>%
    dplyr::arrange(desc(total_count)) %>%
    dplyr::select(strain) %>%
    dplyr::pull()

S_pneumoniae_infant_strain %<>%
  dplyr::mutate(type = factor(type, levels = serotype_by_count))

serotype_frequency_plot <-
  ggplot(S_pneumoniae_infant_strain %>%
           tidyr::pivot_longer(c(carriage,disease),
                               names_to = "Sample type",
                               values_to = "count"),
         aes(x = type,
             y = count,
             colour = `Sample type`,
             fill = `Sample type`)) +
    geom_col() +
    xlab("Serotype") +
    theme_bw() + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    scale_fill_manual(values = epi_colors) +
    scale_colour_manual(values = epi_colors)

(combined_full_epi_data_plot <-
  cowplot::plot_grid(plotlist = list(full_epi_data_plot, serotype_frequency_plot),
                     nrow = 2,
                     ncol = 1,
                     labels = "AUTO")
)

ggsave(combined_full_epi_data_plot,
       file = "full_epi_data_child_strain_plot.png",
       height = 12,
       width = 8
)

```

As many of these serotypes are rare, to facilitate model fitting, we exclude any serotype for which the maximum number of observations is below five, and any serotype found in fewer than five strains, and any strain associated with fewer than five serotypes:

``` {r Plot distribution by serotype in filtered dataset, include = FALSE}

threshold_count <- 5

filtered_S_pneumoniae_infant_strain <-
  S_pneumoniae_infant_strain %>%
    dplyr::filter(carriage >= threshold_count | disease >= threshold_count)  %>%
    dplyr::group_by(type) %>%
    dplyr::mutate(strain_count = n_distinct(strain)) %>%
    dplyr::ungroup() %>%
    dplyr::group_by(strain) %>%
    dplyr::mutate(type_count = n_distinct(type)) %>%
    dplyr::ungroup() %>%
    dplyr::filter(strain_count >= threshold_count | type_count >= threshold_count)

filtered_S_pneumoniae_infant_strain %<>%
    dplyr::mutate(study = factor(study, levels = studies_by_size[studies_by_size %in% unique(filtered_S_pneumoniae_infant_strain$study)]))

filtered_S_pneumoniae_infant_strain %<>%
    dplyr::mutate(type = factor(type,
                                          levels = serotype_by_count[serotype_by_count %in% unique(filtered_S_pneumoniae_infant_strain$type)])) %>%
  dplyr::mutate(strain = factor(strain))

# Generate input for serotype models
infant_serotype_invasiveness <- 
  progressionEstimation::process_input_data(filtered_S_pneumoniae_infant_strain,
                                            condense = FALSE)

# Generate input for strain models
infant_strain_invasiveness <- 
  progressionEstimation::process_input_data(filtered_S_pneumoniae_infant_strain,
                                            type = "strain",
                                            condense = FALSE)

# Generate input for strain and serotype models
infant_serotype_and_strain_invasiveness <- 
  progressionEstimation::process_input_data(filtered_S_pneumoniae_infant_strain,
                                            use_strain = TRUE,
                                            condense = FALSE)

# Generate input for serotype models
infant_serotype_strain_combined_invasiveness <- 
  progressionEstimation::process_input_data(filtered_S_pneumoniae_infant_strain,
                                            combine_strain = TRUE,
                                            condense = FALSE)

(filtered_epi_data_plot <-
  ggplot(filtered_S_pneumoniae_infant_strain %>%
           tidyr::pivot_longer(c(carriage,disease),
                               names_to = "Sample type",
                               values_to = "count"),
         aes(x = study,
             y = count,
             colour = `Sample type`,
             fill = `Sample type`)) +
    geom_col() +
    theme_bw() + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    scale_fill_manual(values = epi_colors) +
    scale_colour_manual(values = epi_colors)
)

(filtered_sero_data_plot <-
  ggplot(filtered_S_pneumoniae_infant_strain %>%
           tidyr::pivot_longer(c(carriage,disease),
                               names_to = "Sample type",
                               values_to = "count"),
         aes(x = type,
             y = count,
             colour = `Sample type`,
             fill = `Sample type`)) +
    geom_col() +
    xlab("Serotype") +
    theme_bw() + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    scale_fill_manual(values = epi_colors) +
    scale_colour_manual(values = epi_colors)
)

(combined_filtered_epi_data_plot <-
  cowplot::plot_grid(plotlist = list(filtered_epi_data_plot, filtered_sero_data_plot),
                     nrow = 2,
                     ncol = 1,
                     labels = "AUTO")
)

ggsave(combined_filtered_epi_data_plot,
       file = "filtered_epi_data_child_strain_plot.png",
       height = 12,
       width = 8
)

```

This filtered dataset comprises `r nrow(filtered_S_pneumoniae_infant_strain)` isolates of `r filtered_S_pneumoniae_infant_strain %>% dplyr::select(type) %>% dplyr::n_distinct()` serotypes, `r filtered_S_pneumoniae_infant_strain %>% dplyr::select(strain) %>% dplyr::n_distinct()` strains, and `r filtered_S_pneumoniae_infant_strain %>% tidyr::unite(combined,strain,type) %>% dplyr::select(combined) %>% dplyr::n_distinct()` strain-serotype combinations.

## Fitting the statistical models

An adjusted type-specific Poisson model can be applied to the data using only classification by serotype (**adjusted serotype-specific Poisson** model):

$$d_{i,j,k} \sim Poisson(\gamma_{i}\nu_{j}\rho_{i,j,k}N_{i}t_{i})$$

``` {r Adjusted serotype-specific Poisson model fit, include = FALSE}

n_chains <- 2
n_iter <- 2.5e4
n_core <- 2
adapt_delta = 0.99
stepsize = 0.01
max_treedepth = 20

adjusted_serotype_specific_poisson_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_serotype_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    stat_model = "poisson",
                                                    model_description = "serotype_specific_poisson",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

adjusted_serotype_specific_poisson_output_df <-
  progressionEstimation::process_progression_rate_model_output(adjusted_serotype_specific_poisson_fit,
                                                               filtered_S_pneumoniae_infant_strain,
                                                               condense = FALSE)

```

We can alternatively fit a negative binomial version of the same model:

$$d_{i,j,k} \sim NegBin(\gamma_{i}\nu_{j}\rho_{i,j,k}N_{i}t_{i})$$

``` {r Adjusted serotype-specific negative binomial model fit, include = FALSE}

adjusted_serotype_specific_negbin_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_serotype_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    stat_model = "negbin",
                                                    model_description = "serotype_specific_negbin",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

adjusted_serotype_specific_negbin_output_df <-
  progressionEstimation::process_progression_rate_model_output(adjusted_serotype_specific_negbin_fit,
                                                               filtered_S_pneumoniae_infant_strain,
                                                               condense = FALSE)

```


An adjusted type-specific Poisson model can alternatively be applied to the data using only classification by strain (**adjusted strain-specific Poisson** model):

$$d_{i,j,k} \sim Poisson(\gamma_{i}\nu_{k}\rho_{i,j,k}N_{i}t_{i})$$

``` {r Adjusted strain-specific Poisson model fit, include = FALSE}

adjusted_strain_specific_poisson_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_strain_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    stat_model = "poisson",
                                                    model_description = "strain_specific_poisson",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

adjusted_strain_specific_poisson_output_df <-
  progressionEstimation::process_progression_rate_model_output(adjusted_strain_specific_poisson_fit,
                                                               filtered_S_pneumoniae_infant_strain,
                                                               type = "strain",
                                                               condense = FALSE)

```

We can also fit a negative binomial equivalent (**adjusted strain-specific negative binomial** model):

$$d_{i,j,k} \sim NegBin(\gamma_{i}\nu_{k}\rho_{i,j,k}N_{i}t_{i})$$
``` {r Adjusted strain-specific negative binomial model fit, include = FALSE}

adjusted_strain_specific_negbin_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_strain_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    stat_model = "negbin",
                                                    model_description = "strain_specific_negbin",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

adjusted_strain_specific_negbin_output_df <-
  progressionEstimation::process_progression_rate_model_output(adjusted_strain_specific_negbin_fit,
                                                               filtered_S_pneumoniae_infant_strain,
                                                               type = "strain",
                                                               condense = FALSE)

```

Models can also combine serotype and strain information, with **invasiveness primarily determined by serotype, and modified by strain**:

$$d_{i,j,k} \sim Poisson(\gamma_{i}\nu_{k}\nu_{k}\rho_{i,j,k}N_{i}t_{i})$$

``` {r Adjusted serotype-specific strain-modified Poisson model fit, include = FALSE}

adjusted_serotype_specific_strain_modified_poisson_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_serotype_and_strain_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    strain_as_secondary_type = TRUE,
                                                    stat_model = "poisson",
                                                    model_description = "serotype_specific_strain_modified_poisson",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

adjusted_serotype_specific_strain_modified_poisson_output_df <-
  progressionEstimation::process_progression_rate_model_output(adjusted_serotype_specific_strain_modified_poisson_fit,
                                                               filtered_S_pneumoniae_infant_strain,
                                                               strain_as_secondary_type = TRUE,
                                                               condense = FALSE)

```

This can also be applied using a negative binomial distribution:

$$d_{i,j,k} \sim NegBin(\gamma_{i}\nu_{k}\nu_{k}\rho_{i,j,k}N_{i}t_{i})$$

``` {r Adjusted serotype-specific strain-modified negative binomial model fit, include = FALSE}

adjusted_strain_specific_strain_modified_negbin_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_serotype_and_strain_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    strain_as_secondary_type = TRUE,
                                                    stat_model = "negbin",
                                                    model_description = "serotype_specific_strain_modified_negbin",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

adjusted_serotype_specific_strain_modified_negbin_output_df <-
  progressionEstimation::process_progression_rate_model_output(adjusted_strain_specific_strain_modified_negbin_fit,
                                                               filtered_S_pneumoniae_infant_strain,
                                                               strain_as_secondary_type = TRUE,
                                                               condense = FALSE)

```

Models can alternative have **invasiveness primarily determined by strain, and modified by serotype**:

$$d_{i,j,k} \sim Poisson(\gamma_{i}\nu_{k}\nu_{k}\rho_{i,j,k}N_{i}t_{i})$$

``` {r Adjusted strain- and serotype-specific Poisson model fit, include = FALSE}

adjusted_strain_specific_serotype_modified_poisson_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_serotype_and_strain_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    strain_as_primary_type = TRUE,
                                                    stat_model = "poisson",
                                                    model_description = "strain_specific_serotype_modified_poisson",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

adjusted_strain_specific_serotype_modified_poisson_output_df <-
  progressionEstimation::process_progression_rate_model_output(adjusted_strain_specific_serotype_modified_poisson_fit,
                                                               filtered_S_pneumoniae_infant_strain,
                                                               strain_as_primary_type = TRUE,
                                                               condense = FALSE)

```

This model can also be applied using a negative binomial model:

$$d_{i,j,k} \sim NegBin(\gamma_{i}\nu_{k}\nu_{k}\rho_{i,j,k}N_{i}t_{i})$$

``` {r Adjusted strain- and serotype-specific negative binomial model fit, include = FALSE}

adjusted_strain_specific_serotype_modified_negbin_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_serotype_and_strain_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    strain_as_primary_type = TRUE,
                                                    stat_model = "negbin",
                                                    model_description = "strain_specific_serotype_modified_negbin",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

adjusted_strain_specific_serotype_modified_negbin_output_df <-
  progressionEstimation::process_progression_rate_model_output(adjusted_strain_specific_serotype_modified_negbin_fit,
                                                               filtered_S_pneumoniae_infant_strain,
                                                               strain_as_primary_type = TRUE,
                                                               condense = FALSE)

```

The final model structure assigns a **different invasiveness to each strain-serotype combination**:

$$d_{i,j,k} \sim Poisson(\gamma_{i}\nu_{j,k}\rho_{i,j,k}N_{i}t_{i})$$

``` {r Adjusted serotype- and strain-specific Poisson model fit, include = FALSE}

adjusted_strain_and_serotype_specific_poisson_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_serotype_strain_combined_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    stat_model = "poisson",
                                                    model_description = "strain_and_serotype_specific_poisson",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

adjusted_strain_and_serotype_specific_poisson_output_df <-
  progressionEstimation::process_progression_rate_model_output(adjusted_strain_and_serotype_specific_poisson_fit,
                                                               filtered_S_pneumoniae_infant_strain,
                                                               combined_strain_type = TRUE,
                                                               condense = FALSE)

```

A version using the negative binomial distribution can also be fitted:

$$d_{i,j,k} \sim NegBin(\gamma_{i}\nu_{j,k}\rho_{i,j,k}N_{i}t_{i})$$
``` {r Adjusted serotype- and strain-specific negative binomial model fit, include = FALSE}

adjusted_strain_and_serotype_specific_negbin_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_serotype_strain_combined_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    stat_model = "negbin",
                                                    model_description = "strain_and_serotype_specific_negbin",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

adjusted_strain_and_serotype_specific_negbin_output_df <-
  progressionEstimation::process_progression_rate_model_output(adjusted_strain_and_serotype_specific_negbin_fit,
                                                               filtered_S_pneumoniae_infant_strain,
                                                               combined_strain_type = TRUE,
                                                               condense = FALSE)

```

To check the models have fitted correctly, we can plot the $\hat{R}$ values across MCMCs:

``` {r Plot r hat values}

fit_list <- list(adjusted_serotype_specific_poisson_fit,
                                  adjusted_serotype_specific_negbin_fit,
                                  adjusted_strain_specific_poisson_fit,
                                  adjusted_strain_specific_negbin_fit,
                                  adjusted_serotype_specific_strain_modified_poisson_fit,
                                  adjusted_strain_specific_strain_modified_negbin_fit,
                                  adjusted_strain_specific_serotype_modified_poisson_fit,
                                  adjusted_strain_specific_serotype_modified_negbin_fit,
                                  adjusted_strain_and_serotype_specific_poisson_fit,
                                  adjusted_strain_and_serotype_specific_negbin_fit)

rhat_plot <- function(fit) {
  rhat_plot <- plot(fit, plotfun = "rhat", binwidth = 0.00005)
  rhat_plot <- rhat_plot + theme(axis.text.x = element_text(angle = 90))
}

rhat_plots <- lapply(fit_list, rhat_plot)

(strain_and_serotype_rhat_plots <-
  cowplot::plot_grid(plotlist = rhat_plots, ncol = 5, nrow = 2, labels = "AUTO")
)

ggsave(strain_and_serotype_rhat_plots,
       file = "strain_and_serotype_rhat_plots.png",
       width = 11,
       height = 7
)

```

Convergence can also be checked using trace plots of the log likelihood values:

``` {r Plot log likelihood traces}

plot_lp <- function(fit) {
  pl <- rstan::traceplot(fit, pars = "lp__")
  no_leg_pl <- pl + theme(legend.position = "none",
                          axis.text.x = element_text(angle = 90))
  return(no_leg_pl)
}

trace_plots <- lapply(fit_list, plot_lp)

(strain_and_serotype_trace_plots <-
  cowplot::plot_grid(plotlist = trace_plots, ncol = 5, nrow = 2, labels = "AUTO")
)

ggsave(strain_and_serotype_trace_plots,
       file = "strain_and_serotype_trace_plots.png",
       width = 11,
       height = 7
)

```

## Compare model observations and predictions

For each model, the output can be processed, and the observations plotted against each model's predictions.

``` {r Process model outputs and plot predictions, fig.height = 18}

model_outputs <- list(
  adjusted_serotype_specific_poisson_output_df,
  adjusted_serotype_specific_negbin_output_df,
  adjusted_strain_specific_poisson_output_df,
  adjusted_strain_specific_negbin_output_df,
  adjusted_serotype_specific_strain_modified_poisson_output_df,
  adjusted_serotype_specific_strain_modified_negbin_output_df,
  adjusted_strain_specific_serotype_modified_poisson_output_df,
  adjusted_strain_specific_serotype_modified_negbin_output_df,
  adjusted_strain_and_serotype_specific_poisson_output_df,
  adjusted_strain_and_serotype_specific_negbin_output_df
)

label_list <- list(
  "type",
  "type",
  "type",
  "type",
  "type",
  "type",
  "type",
  "type",
  "combined",
  "combined"
)

prediction_plots <- list()
for (i in 1:length(model_outputs)) {
  prediction_plots[[i]] <- progressionEstimation::plot_case_carrier_predictions(
                                                       model_outputs[[i]],
                                                       label_col = label_list[[i]],
                                                       legend = FALSE,
                                                       n_label = 0)
}

no_leg_plot <- cowplot::plot_grid(plotlist = prediction_plots,
                                  ncol = 1,
                                  nrow = 8,
                                  labels = "AUTO",
                                  vjust = -0.01) +
      theme(plot.margin = unit(c(0.5,0,0,0), "cm"))

prediction_plot_legend <- progressionEstimation::plot_case_carrier_predictions(model_outputs[[1]], just_legend = TRUE)

(pred_v_obs_plot <- 
  cowplot::plot_grid(no_leg_plot,
                     prediction_plot_legend,
                     ncol = 1,
                     rel_heights = c(1,0.1)))

ggsave(pred_v_obs_plot,
       file = "infant_strain_serotypes_pred_v_obs_plot.png",
       height = 20,
       width = 10)

```

The deviation of the predicted and observed values can be simply evaluated using the root mean square error:

``` {r Calculate RMSE, fig.height = 10}

obs_pred_df <-
  dplyr::bind_rows(model_outputs) %>%
  dplyr::select(model_name,carriage_rmse,disease_rmse,phi,phi_lower,phi_upper) %>%
  tidyr::pivot_longer(c(carriage_rmse,disease_rmse), names_to = "Observation", values_to = "RMSE") %>%
  dplyr::mutate(model_name = factor(model_name,
                                    levels = c(
                                      "serotype_specific_poisson",
                                      "serotype_specific_negbin",
                                      "strain_specific_poisson",
                                      "strain_specific_negbin",
                                      "serotype_specific_strain_modified_poisson",
                                      "serotype_specific_strain_modified_negbin",
                                      "strain_specific_serotype_modified_poisson",
                                      "strain_specific_serotype_modified_negbin",
                                      "strain_and_serotype_specific_poisson",
                                      "strain_and_serotype_specific_negbin"
                                      )
                                    )
                ) %>%
  dplyr::mutate(Observation = dplyr::case_when(
                    Observation == "carriage_rmse" ~ "Carriage",
                    Observation == "disease_rmse" ~ "Disease"
                  )
                )

(strain_and_serotype_rmse_plot <-
  ggplot(obs_pred_df, aes(x = model_name, y = RMSE)) +
    geom_point(position = position_jitter(width = 0.25),
               alpha = 0.25,
               cex = 0.75,
               colour = "blue",
               pch = 4) +
    geom_violin(fill = NA) +
    scale_y_continuous(trans="log10") +
    xlab("Model name") +
    scale_x_discrete(labels = model_name_labels) +
    theme_bw() +
    facet_grid(Observation ~ .) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
)

ggsave(strain_and_serotype_rmse_plot,
       file = "strain_and_serotype_rmse_plot.png",
       width = 7,
       height = 7
)

```

The fits of the negative binomial can be evaluated through plotting the estimates of the precision parameter, $\phi$. As $\phi$ increases, the variance of the negative binomial distribution decreases, and the negative binomal model becomes more similar to the Poisson model.

``` {r Plot precision parameters for negative binomial models, fig.width = 6, fig.height = 10}

(strain_and_serotype_precision_parameters <-
  ggplot(obs_pred_df %>%
          dplyr::filter(!is.na(phi)) %>%
          dplyr::group_by(model_name) %>%
          dplyr::slice(1) %>%
          dplyr::ungroup(),
        aes(x = model_name,
            y = phi,
            ymin = phi_lower,
            ymax = phi_upper)) +
    geom_point() +
    geom_errorbar(width = 0.25) +
    theme_bw() +
    scale_y_continuous(trans="log10") +
    ylab(expression(phi)) +
    xlab("Model name") +
    scale_x_discrete(labels = model_name_labels[c(2,4,6,8,10)]) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
)

ggsave(strain_and_serotype_precision_parameters,
       file = "strain_and_serotype_precision_plot.png",
       width = 6,
       height = 6
)

```

## Plot secondary invasiveness for modified invasiveness models

To check these are not being constrained by the prior limits, we plot the invasiveness modification values, first for the type-specific strain-modified Poisson model:

``` {r Secondary invasiveness in the type-specific strain-modified Poisson model}

order_strains <-
  model_outputs[[5]] %>%
    dplyr::select(strain,secondary_nu) %>%
    dplyr::distinct() %>%
    dplyr::arrange(desc(secondary_nu)) %>%
    dplyr::select(strain) %>%
    dplyr::mutate(strain = as.character(strain)) %>%
    dplyr::pull()

(strain_inv <-
  progressionEstimation::plot_progression_rates(model_outputs[[5]] %>%
                                                  dplyr::mutate(strain = factor(strain,
                                                                                levels = order_strains)),
                                                type = "strain"))

ggsave(strain_inv,
       file = "type_specific_strain_modified_strain_invasiveness.png",
       width = 8,
       height = 6)

```

``` {r Secondary invasiveness in the type-specific strain-modified negative binomial model}

progressionEstimation::plot_progression_rates(model_outputs[[6]], type = "strain")

```

``` {r Secondary invasiveness in the strain-specific type-modified Poisson model}

progressionEstimation::plot_progression_rates(model_outputs[[7]])

```

``` {r Secondary invasiveness in the strain-specific type-modified negative binomial model}

progressionEstimation::plot_progression_rates(model_outputs[[8]])

```

## Run model comparison with leave-one-out cross-validation

The model likelihoods can be compared using leave-one-out cross-validation:

``` {r Comparison with LOO-CV using full log likelihood}

loo_comparison <- progressionEstimation::compare_model_fits_with_loo(fit_list,
                                                                     use_moments = FALSE,
                                                                     num_threads = n_core)

loo_comparison %>%
  kableExtra::kable()  %>%
  kableExtra::kable_styling(latex_options = "scale_down")

write.csv(loo_comparison,
          file = "child_strain_loo_comparison.csv",
          quote = FALSE,
          row.names = TRUE)

```

The Pareto distribution k values are too high for robust estimates of the ELPD. This reflects there being too few observations per parameter for this type of evaluation. Even usingt the disease likelihoods, we cannot calculate an accuraste cross-validation:

``` {r Comparison with LOO-CV using disease distribution log likelihood}

disease_loo_comparison <- progressionEstimation::compare_model_fits_with_loo(fit_list,
                                                                     log_lik_param = "disease_log_lik",
                                                                     use_moments = FALSE,
                                                                     num_threads = n_core)

disease_loo_comparison %>%
  kableExtra::kable()  %>%
  kableExtra::kable_styling(latex_options = "scale_down")

write.csv(disease_loo_comparison,
          file = "child_strain_disease_loo_comparison.csv",
          quote = FALSE,
          row.names = TRUE)

```

## Run model comparison with Bayes factors

As the models can instead be compared with Bayes factors:

``` {r Comparison with BF}

bf_comparison <- progressionEstimation::compare_model_fits_with_bf(fit_list,
                                                                   num_iter = n_iter,
                                                                   num_threads = n_core)
bf_comparison %>%
  kableExtra::kable()  %>%
  kableExtra::kable_styling(latex_options = "scale_down")

write.csv(bf_comparison,
          file = "child_strain_bf_comparison.csv",
          quote = FALSE,
          row.names = FALSE)

```

## Plot serotype invasiveness

The best-fitting model can then be applied to the overall dataset.

``` {r Plot invasiveness estimates from best-fitting model}

# Generate input for strain and serotype models
full_infant_serotype_and_strain_invasiveness <- 
  progressionEstimation::process_input_data(S_pneumoniae_infant_strain,
                                            use_strain = TRUE,
                                            condense = FALSE)

full_adjusted_serotype_specific_strain_modified_poisson_fit <- 
  progressionEstimation::fit_progression_rate_model(full_infant_serotype_and_strain_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    strain_as_secondary_type = TRUE,
                                                    stat_model = "poisson",
                                                    model_description = "serotype_specific_strain_modified_poisson",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

rhat_plot <- plot(full_adjusted_serotype_specific_strain_modified_poisson_fit,
                  plotfun = "rhat",
                  binwidth = 0.00005)

trace_plot <- rstan::traceplot(full_adjusted_serotype_specific_strain_modified_poisson_fit,
                               pars = "lp__") +
              theme(axis.text.x = element_text(angle = 90))

(full_strain_and_serotype_validation_plot <-
  cowplot::plot_grid(plotlist = list(rhat_plot,trace_plot),
                     nrow = 1,
                     ncol = 2,
                     labels = "AUTO")
)

ggsave(full_strain_and_serotype_validation_plot,
       file = "full_strain_and_serotype_validation_plot.png",
       width = 7,
       height = 5
)

```

``` {r Plot invasiveness across all serotypes}

# Annotate serotypes by status
best_fitting_output <- 
  progressionEstimation::process_progression_rate_model_output(full_adjusted_serotype_specific_strain_modified_poisson_fit,
                                                               S_pneumoniae_infant_strain,
                                                               strain_as_secondary_type = TRUE,
                                                               condense = FALSE) %>%
    dplyr::mutate("type" = S_pneumoniae_infant_strain$type) %>%
    dplyr::mutate("classification" = dplyr::case_when(
        type %in% vaccine_types[["PCV7"]] ~ "PCV7",
        type %in% vaccine_types[["PCV10"]] ~ "PCV10",
        type %in% vaccine_types[["PCV13"]] ~ "PCV13",
        type %in% vaccine_types[["PCV15"]] ~ "PCV15",
        type %in% vaccine_types[["PCV20"]] ~ "PCV20",
        type %in% vaccine_types[["PPV23"]] ~ "PPV23",
        TRUE ~ "No PCV"
      )
    ) %>%
    dplyr::mutate(classification = factor(classification, levels = c("PCV7",
                                                                     "PCV10",
                                                                     "PCV13",
                                                                     "PCV15",
                                                                     "PCV20",
                                                                     "PPV23",
                                                                     "No PCV"))) %>%
    dplyr::mutate(combined_nu = nu * secondary_nu) %>%
    tidyr::unite(combined,
                 type,strain,
                 sep = "_",
                 remove = FALSE)

# Order serotypes
serotypes_by_invasiveness <-
  best_fitting_output %>%
    dplyr::select(type,nu) %>%
    dplyr::distinct() %>%
    dplyr::arrange(desc(nu)) %>%
    dplyr::select(type) %>%
    dplyr::mutate(type = as.character(type)) %>%
    dplyr::pull()

# Order strains
strains_by_invasiveness <-
  best_fitting_output %>%
    dplyr::select(strain,secondary_nu) %>%
    dplyr::distinct() %>%
    dplyr::arrange(desc(secondary_nu)) %>%
    dplyr::select(strain) %>%
    dplyr::mutate(strain = as.character(strain)) %>%
    dplyr::pull()

best_fitting_output %<>%
  dplyr::mutate(type = factor(type, levels = serotypes_by_invasiveness)) %>%
  dplyr::mutate(strain = factor(strain, levels = strains_by_invasiveness))

# Plot
strain_invasiveness <-
  progressionEstimation::plot_progression_rates(best_fitting_output,
                                                type = "strain",
                                                unit_time = "year",
                                                type_name = "GPSC",
                                                use_sample_size = TRUE) +
    ylab("Progression rate contribution\n(disease per carrier per year)") +
    theme(axis.text.x = element_text(size = 6))

type_invasiveness <-
  progressionEstimation::plot_progression_rates(best_fitting_output,
                                                type = "type",
                                                unit_time = "year",
                                                type_name = "Serotype",
                                                colour_col = "classification",
                                                colour_palette = vaccine_colours,
                                                use_sample_size = TRUE) +
    ylab("Progression rate contribution\n(disease per carrier per year)") +
    theme(axis.text.x = element_text(size = 6))

(joint_invasiveness <-
  cowplot::plot_grid(plotlist = list(strain_invasiveness + theme(legend.position = "none"),
                                     type_invasiveness),
                     labels = "AUTO",
                     nrow = 2,
                     rel_heights = c(1,1.25)))

ggsave(joint_invasiveness,
       file = "full_strain_and_serotype_invasiveness_plot.png",
       width = 20,
       height = 10
)

```


``` {r Alternative plot of combined nu}

not_in_current_vaccines <- c("No PCV","PPV23","PCV20","PCV15")

combined_levels <-
  best_fitting_output %>%
    dplyr::select(combined,combined_nu) %>%
    dplyr::distinct() %>%
    dplyr::arrange(desc(combined_nu)) %>%
    dplyr::select(combined) %>%
    dplyr::mutate(combined = as.character(combined)) %>%
    dplyr::pull()

best_fitting_output %<>%
  dplyr::mutate(combined = factor(combined, levels = combined_levels))

(all_combined_invasiveness <-
  ggplot(best_fitting_output %>%
           dplyr::select(combined,combined_nu, classification),
         aes(x = combined,
             y = combined_nu,
             colour = classification,
             label = combined)) +
    geom_point() +
    scale_y_continuous(trans = "log10") +
    ylab(expression(nu~"(disease per carrier per year)")) +
    scale_colour_manual(values = vaccine_colours) +
    xlab("Combined serotype-strain genotype") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90,
                                     hjust = 1,
                                     vjust = 0.5,
                                     size = 3.5),
          legend.position = "bottom") +
    ggrepel::geom_label_repel(data = best_fitting_output %>%
                                      dplyr::select(combined,combined_nu, classification) %>%
                                      dplyr::filter(classification %in% not_in_current_vaccines[1:2]) %>%
                                        dplyr::filter(combined_nu > 10**(-4)) %>%
                                        dplyr::distinct(),
                              aes(label = combined),
                              force_pull = 0.0,
                              force = 10,
                              direction = "y",
                              size = 4,
                              max.overlaps = 20)
)

ggsave(all_combined_invasiveness,
       file = "combined_invasiveness_for_all_genotypes.png",
       width = 11,
       height = 8)

```

## Save overall dataset
 
``` {r Save dataset}
 
write.csv(best_fitting_output %>%
            dplyr::select(combined,type,strain,
                          nu,nu_lower,nu_upper,
                          secondary_nu,secondary_nu_lower,secondary_nu_upper) %>%
            dplyr::rename(genotype = combined) %>%
            dplyr::rename(serotype_invasiveness = nu) %>%
            dplyr::rename(serotype_invasiveness_lower = nu_lower) %>%
            dplyr::rename(serotype_invasiveness_upper = nu_upper) %>%
            dplyr::rename(strain_invasiveness = secondary_nu) %>%
            dplyr::rename(strain_invasiveness_lower = secondary_nu_lower) %>%
            dplyr::rename(strain_invasiveness_upper = secondary_nu_upper) %>%
            dplyr::distinct() %>%
            dplyr::arrange(genotype),
          file = "Dataset_S3.csv",
          quote = F,
          row.names = F)

```

## Filter to only larger sample sizes

``` {r Plot only larger sample size}

# Annotate sample size
filtered_best_fitting_output <-
  best_fitting_output %>%
    dplyr::group_by(combined) %>%
    dplyr::mutate(num_observations = sum(carriage+disease)) %>%
    dplyr::ungroup() %>%
    dplyr::filter(num_observations >= 10) %>%
    dplyr::group_by(strain) %>%
    dplyr::mutate(num_serotypes = dplyr::n_distinct(type)) %>%
    dplyr::ungroup() %>%
    dplyr::group_by(type) %>%
    dplyr::mutate(num_strains = dplyr::n_distinct(strain)) %>%
    dplyr::ungroup()

# Plot
filtered_strain_invasiveness <-
  progressionEstimation::plot_progression_rates(filtered_best_fitting_output,
                                                type = "strain",
                                                unit_time = "year",
                                                type_name = "GPSC",
                                                use_sample_size = TRUE) +
    theme(axis.text.x = element_text(size = 6))

filtered_type_invasiveness <-
  progressionEstimation::plot_progression_rates(filtered_best_fitting_output,
                                                type = "type",
                                                unit_time = "year",
                                                type_name = "Serotype",
                                                colour_col = "classification",
                                                colour_palette = vaccine_colours,
                                                use_sample_size = TRUE) +
    theme(axis.text.x = element_text(size = 6))

(filtered_joint_invasiveness <-
  cowplot::plot_grid(plotlist = list(filtered_strain_invasiveness + theme(legend.position = "none"),
                                     filtered_type_invasiveness),
                     labels = "AUTO",
                     nrow = 2,
                     rel_heights = c(1,1.25)))

ggsave(filtered_joint_invasiveness,
       file = "filtered_full_strain_and_serotype_invasiveness_plot.png",
       width = 20,
       height = 10
)

```

``` {r Plot variation within serotypes, fig.height = 12}

# Function needed if processing combined serotype/strain assignments
mixedrank = function(x) order(gtools::mixedorder(as.character(x)))

# Reorder by serotype
serotype_levels <-
  filtered_best_fitting_output %>%
    dplyr::select(type,classification) %>%
    dplyr::distinct() %>%
    dplyr::group_by(classification) %>%
    dplyr::arrange(mixedrank(type),
                   .by_group = TRUE) %>%
    dplyr::ungroup() %>%
    dplyr::select(type) %>%
    dplyr::mutate(as.character(type)) %>%
    dplyr::pull()

# Reorder by strain
strain_levels <-
  filtered_best_fitting_output %>%
    dplyr::select(strain,secondary_nu) %>%
    dplyr::distinct() %>%
    dplyr::arrange(desc(secondary_nu)) %>%
    dplyr::select(strain) %>%
    dplyr::mutate(as.character(strain)) %>%
    dplyr::pull()

filtered_best_fitting_output %<>%
  dplyr::mutate(strain = factor(strain, levels = strain_levels)) %>%
  dplyr::mutate(type = factor(type, levels = serotype_levels))

(serotype_invasiveness_plot <-
  plot_progression_rate_by_type(filtered_best_fitting_output %>%
                                                  dplyr::filter(num_strains > 1),
                                                type = "strain",
                                                unit_time = "year",
                                                type_name = "Strain",
                                                colour_col = "classification",
                                                colour_palette = vaccine_colours,
                                                use_sample_size = TRUE) +
                                                facet_wrap(.~type,
                                                           scales = 'free_x'))

ggsave(serotype_invasiveness_plot,
       file = "within_serotype_invasiveness_variation_plot.png",
       width = 8,
       height = 12
)

ggsave(serotype_invasiveness_plot,
       file = "within_serotype_invasiveness_variation_plot.pdf",
       width = 8,
       height = 12
)

```


``` {r Plot variation within strains, fig.height = 12}

# Reorder by serotype
serotype_levels <-
  filtered_best_fitting_output %>%
    dplyr::select(type,nu) %>%
    dplyr::distinct() %>%
    dplyr::arrange(desc(nu)) %>%
    dplyr::ungroup() %>%
    dplyr::select(type) %>%
    dplyr::mutate(as.character(type)) %>%
    dplyr::pull()

# Reorder by strain
strain_levels <-
  gtools::mixedsort(
    filtered_best_fitting_output %>%
      dplyr::select(strain) %>%
      dplyr::distinct() %>%
      dplyr::mutate(strain = as.character(strain)) %>%
      dplyr::pull()
    )

filtered_best_fitting_output %<>%
  dplyr::mutate(strain = factor(strain, levels = strain_levels)) %>%
  dplyr::mutate(type = factor(type, levels = serotype_levels))

(strain_invasiveness_plot <-
  plot_progression_rate_by_type(filtered_best_fitting_output %>%
                                                    dplyr::filter(num_serotypes > 1),
                                                  type = "type",
                                                  unit_time = "year",
                                                  type_name = "Serotype",
                                                  colour_col = "classification",
                                                  colour_palette = vaccine_colours,
                                                  use_sample_size = TRUE) +
                                                  facet_wrap(.~strain,
                                                             scales = 'free_x')
)

ggsave(strain_invasiveness_plot,
       file = "within_strain_invasiveness_variation_plot.png",
       width = 8,
       height = 8
)

ggsave(strain_invasiveness_plot,
       file = "within_strain_invasiveness_variation_plot.pdf",
       width = 8,
       height = 8
)

```

## Plot study-specific scale factors

``` {r Plot study-specific scale factor estimates from best-fitting model}

(scale_factor_plot <-
  progressionEstimation::plot_study_scale_factors(best_fitting_output))

ggsave(scale_factor_plot,
       file = "full_strain_and_serotype_scale_factor_plot.png",
       width = 6,
       height = 6
)

```

``` {r Sensitivity to population sizes}

sensitivity_S_pneumoniae_infant_strain <-
  S_pneumoniae_infant_strain %>%
    dplyr::filter(carriage >= threshold_count | disease >= threshold_count) %>%
    dplyr::mutate(carriage_samples = dplyr::case_when(
                      study %in% c("Finland.Pre.PCV","Oxford.pre.PCV","Stockholm.pre.PCV") ~ as.integer(carriage_samples*100),
                      TRUE ~ carriage_samples
                    )
                  ) %>%
    dplyr::group_by(type) %>%
    dplyr::mutate(strain_count = n_distinct(strain)) %>%
    dplyr::ungroup() %>%
    dplyr::group_by(strain) %>%
    dplyr::mutate(type_count = n_distinct(type)) %>%
    dplyr::ungroup() %>%
    dplyr::filter(strain_count >= threshold_count | type_count >= threshold_count)

sensitivity_S_pneumoniae_infant_strain %<>%
    dplyr::mutate(study = factor(study, levels = studies_by_size[studies_by_size %in% unique(sensitivity_S_pneumoniae_infant_strain$study)]))

sensitivity_S_pneumoniae_infant_strain %<>%
    dplyr::mutate(type = factor(type,
                                          levels = serotype_by_count[serotype_by_count %in% unique(sensitivity_S_pneumoniae_infant_strain$type)])) %>%
  dplyr::mutate(strain = factor(strain))

# Generate input for serotype models
sensitivity_infant_serotype_invasiveness <- 
  progressionEstimation::process_input_data(sensitivity_S_pneumoniae_infant_strain,
                                            condense = FALSE)

# Generate input for strain models
sensitivity_infant_strain_invasiveness <- 
  progressionEstimation::process_input_data(sensitivity_S_pneumoniae_infant_strain,
                                            type = "strain",
                                            condense = FALSE)

# Generate input for strain and serotype models
sensitivity_infant_serotype_and_strain_invasiveness <- 
  progressionEstimation::process_input_data(sensitivity_S_pneumoniae_infant_strain,
                                            use_strain = TRUE,
                                            condense = FALSE)

# Generate input for serotype models
sensitivity_infant_serotype_strain_combined_invasiveness <- 
  progressionEstimation::process_input_data(sensitivity_S_pneumoniae_infant_strain,
                                            combine_strain = TRUE,
                                            condense = FALSE)


```

Fit the first model:

``` {r First sensitivity test}
sensitivity_adjusted_serotype_specific_poisson_fit <- 
  progressionEstimation::fit_progression_rate_model(sensitivity_infant_serotype_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    stat_model = "poisson",
                                                    model_description = "serotype_specific_poisson",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

sensitivity_adjusted_serotype_specific_poisson_output_df <-
  progressionEstimation::process_progression_rate_model_output(sensitivity_adjusted_serotype_specific_poisson_fit,
                                                               sensitivity_S_pneumoniae_infant_strain,
                                                               condense = FALSE)
```

``` {r Adjusted serotype-specific negative binomial model fit sensitivity test, include = FALSE}

sensitivity_adjusted_serotype_specific_negbin_fit <- 
  progressionEstimation::fit_progression_rate_model(sensitivity_infant_serotype_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    stat_model = "negbin",
                                                    model_description = "serotype_specific_negbin",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

sensitivity_adjusted_serotype_specific_negbin_output_df <-
  progressionEstimation::process_progression_rate_model_output(sensitivity_adjusted_serotype_specific_negbin_fit,
                                                               sensitivity_S_pneumoniae_infant_strain,
                                                               condense = FALSE)

```

``` {r Adjusted strain-specific Poisson model fit sensitivity test, include = FALSE}

sensitivity_adjusted_strain_specific_poisson_fit <- 
  progressionEstimation::fit_progression_rate_model(sensitivity_infant_strain_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    stat_model = "poisson",
                                                    model_description = "strain_specific_poisson",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

sensitivity_adjusted_strain_specific_poisson_output_df <-
  progressionEstimation::process_progression_rate_model_output(sensitivity_adjusted_strain_specific_poisson_fit,
                                                               sensitivity_S_pneumoniae_infant_strain,
                                                               type = "strain",
                                                               condense = FALSE)

```


``` {r Adjusted strain-specific negative binomial model fit sensitivity test, include = FALSE}

sensitivity_adjusted_strain_specific_negbin_fit <- 
  progressionEstimation::fit_progression_rate_model(sensitivity_infant_strain_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    stat_model = "negbin",
                                                    model_description = "strain_specific_negbin",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

sensitivity_adjusted_strain_specific_negbin_output_df <-
  progressionEstimation::process_progression_rate_model_output(sensitivity_adjusted_strain_specific_negbin_fit,
                                                               sensitivity_S_pneumoniae_infant_strain,
                                                               type = "strain",
                                                               condense = FALSE)

```






``` {r Adjusted serotype-specific strain-modified Poisson model fit sensitivity test, include = FALSE}

sensitivity_adjusted_serotype_specific_strain_modified_poisson_fit <- 
  progressionEstimation::fit_progression_rate_model(sensitivity_infant_serotype_and_strain_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    strain_as_secondary_type = TRUE,
                                                    stat_model = "poisson",
                                                    model_description = "serotype_specific_strain_modified_poisson",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

sensitivity_adjusted_serotype_specific_strain_modified_poisson_output_df <-
  progressionEstimation::process_progression_rate_model_output(sensitivity_adjusted_serotype_specific_strain_modified_poisson_fit,
                                                               sensitivity_S_pneumoniae_infant_strain,
                                                               strain_as_secondary_type = TRUE,
                                                               condense = FALSE)

```



``` {r Adjusted serotype-specific strain-modified negative binomial model fit sensitivity test, include = FALSE}

sensitivity_adjusted_strain_specific_strain_modified_negbin_fit <- 
  progressionEstimation::fit_progression_rate_model(sensitivity_infant_serotype_and_strain_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    strain_as_secondary_type = TRUE,
                                                    stat_model = "negbin",
                                                    model_description = "serotype_specific_strain_modified_negbin",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

sensitivity_adjusted_serotype_specific_strain_modified_negbin_output_df <-
  progressionEstimation::process_progression_rate_model_output(sensitivity_adjusted_strain_specific_strain_modified_negbin_fit,
                                                               sensitivity_S_pneumoniae_infant_strain,
                                                               strain_as_secondary_type = TRUE,
                                                               condense = FALSE)

```



``` {r Adjusted strain-specific serotype-modified Poisson model fit sensitivity test, include = FALSE}

sensitivity_adjusted_strain_specific_serotype_modified_poisson_fit <- 
  progressionEstimation::fit_progression_rate_model(sensitivity_infant_serotype_and_strain_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    strain_as_primary_type = TRUE,
                                                    stat_model = "poisson",
                                                    model_description = "strain_specific_serotype_modified_poisson",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

sensitivity_adjusted_strain_specific_serotype_modified_poisson_output_df <-
  progressionEstimation::process_progression_rate_model_output(sensitivity_adjusted_strain_specific_serotype_modified_poisson_fit,
                                                               sensitivity_S_pneumoniae_infant_strain,
                                                               strain_as_primary_type = TRUE,
                                                               condense = FALSE)

```



``` {r Adjusted strain-specific serotype-modified negative binomial model fit sensitivity test, include = FALSE}

sensitivity_adjusted_strain_specific_serotype_modified_negbin_fit <- 
  progressionEstimation::fit_progression_rate_model(sensitivity_infant_serotype_and_strain_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    strain_as_primary_type = TRUE,
                                                    stat_model = "negbin",
                                                    model_description = "strain_specific_serotype_modified_negbin",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

sensitivity_adjusted_strain_specific_serotype_modified_negbin_output_df <-
  progressionEstimation::process_progression_rate_model_output(sensitivity_adjusted_strain_specific_serotype_modified_negbin_fit,
                                                               sensitivity_S_pneumoniae_infant_strain,
                                                               strain_as_primary_type = TRUE,
                                                               condense = FALSE)

```


``` {r Adjusted serotype- and strain-specific Poisson model fit sensitivity test, include = FALSE}

sensitivity_adjusted_strain_and_serotype_specific_poisson_fit <- 
  progressionEstimation::fit_progression_rate_model(sensitivity_infant_serotype_strain_combined_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    stat_model = "poisson",
                                                    model_description = "strain_and_serotype_specific_poisson",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

sensitivity_adjusted_strain_and_serotype_specific_poisson_output_df <-
  progressionEstimation::process_progression_rate_model_output(sensitivity_adjusted_strain_and_serotype_specific_poisson_fit,
                                                               sensitivity_S_pneumoniae_infant_strain,
                                                               combined_strain_type = TRUE,
                                                               condense = FALSE)

```


``` {r Adjusted serotype- and strain-specific negative binomial model fit sensitivity test, include = FALSE}

sensitivity_adjusted_strain_and_serotype_specific_negbin_fit <- 
  progressionEstimation::fit_progression_rate_model(sensitivity_infant_serotype_strain_combined_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    stat_model = "negbin",
                                                    model_description = "strain_and_serotype_specific_negbin",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core,
                                                    adapt_delta_value = adapt_delta,
                                                    stepsize_value = stepsize,
                                                    max_treedepth_value = max_treedepth)

sensitivity_adjusted_strain_and_serotype_specific_negbin_output_df <-
  progressionEstimation::process_progression_rate_model_output(sensitivity_adjusted_strain_and_serotype_specific_negbin_fit,
                                                               sensitivity_S_pneumoniae_infant_strain,
                                                               combined_strain_type = TRUE,
                                                               condense = FALSE)

```

``` {r Compare sensitivity fits}

sensitivity_fit_list <- list(
  sensitivity_adjusted_serotype_specific_poisson_fit,
  sensitivity_adjusted_serotype_specific_negbin_fit,
  sensitivity_adjusted_strain_specific_poisson_fit,
  sensitivity_adjusted_strain_specific_negbin_fit,
  sensitivity_adjusted_serotype_specific_strain_modified_poisson_fit,
  sensitivity_adjusted_strain_specific_strain_modified_negbin_fit,
  sensitivity_adjusted_strain_specific_serotype_modified_poisson_fit,
  sensitivity_adjusted_strain_specific_serotype_modified_negbin_fit,
  sensitivity_adjusted_strain_and_serotype_specific_poisson_fit,
  sensitivity_adjusted_strain_and_serotype_specific_negbin_fit
)

sensitivity_bf_comparison <- 
  progressionEstimation::compare_model_fits_with_bf(
                                                    sensitivity_fit_list,
                                                    num_iter = n_iter,
                                                    num_threads = n_core)

sensitivity_bf_comparison %>%
  kableExtra::kable()  %>%
  kableExtra::kable_styling(latex_options = "scale_down")

write.csv(bf_comparison,
          file = "child_strain_bf_sensitivity_comparison.csv",
          quote = FALSE,
          row.names = FALSE)

```

