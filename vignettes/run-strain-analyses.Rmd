---
title: "Analysis of invasiveness in *S. pneumoniae* using strain and serotype information"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{run-strain-analyses}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(rmarkdown.html_vignette.check_title = FALSE)
```

```{r setup}
# Load dependencies
require(tidyverse)
require(magrittr)
require(rstan)
require(bridgesampling)
require(loo)
require(cowplot)
require(ggrepel)
require(xlsx)

# Load stan package
library(progressionEstimation)
pkgbuild::compile_dll()
roxygen2::roxygenize(package.dir = "..")
```

This analysis will combine both information on *S. pneumoniae* isolates' serotype and strain background, using the strain definitions generated by [PopPUNK](https://github.com/johnlees/PopPUNK) described by the [Global Pneumococcal Sequencing project](pneumogen.net). These analyses requires a different input, which specifies both the strains of the isolates, and a second classification in the `categorisation` column of the input spreadsheet. These data can be loaded using `use_strain = TRUE`:

```{r Read spreadsheet}

s_pneumoniae_strains_df <-
  progressionEstimation::process_input_xlsx("s_pneumoniae_strains_sweden.xlsx",
                                            use_strain = TRUE)

```

The strain data can be loaded in four ways:

* by serotype - using the default `process_input_data` command

* by strain - by specifying that the `subtype` to be used is the `strain` column, rather than the `categorisation` column

* by serotype and strain - by using the `categorisation` column as the subtype and additionally specifying `use_strain = TRUE`, the population will be classified by separately by the two categories, serotype and strain

* combining serotype and strain - by using the `categorisation` column as the subtype and additionally specifying `combine_strain = TRUE`, the population will be divided based on the combination of strain and serotype (i.e. there is no relationship between isolates unless they share both serotype and strain)

```{r Process data frame}

# Load data by serotype
s_pneumoniae_sweden_by_serotype_data <-
  progressionEstimation::process_input_data(s_pneumoniae_strains_df,
                                            condense = FALSE)

# Load data by strain
s_pneumoniae_sweden_by_strain_data <-
  progressionEstimation::process_input_data(s_pneumoniae_strains_df,
                                            subtype = "strain",
                                            condense = FALSE)

# Load data by strain and serotype
s_pneumoniae_sweden_by_serotype_and_strain_data <-
  progressionEstimation::process_input_data(s_pneumoniae_strains_df,
                                            use_strain = TRUE,
                                            condense = FALSE)

# Load data combining strain and serotype
s_pneumoniae_sweden_combine_serotype_and_strain_data <-
  progressionEstimation::process_input_data(s_pneumoniae_strains_df,
                                            combine_strain = TRUE,
                                            condense = FALSE)

```

## Fitting the model

There are then five versions of the same model structure that can be fitted to these data, using the classification of isolates having a serotype $j$ and strain $k$:

* invasiveness is determined by serotype: $\nu_{j}$

* invasiveness is determined by strain: $\nu_{k}$

* invasiveness is primarily determined by serotype, and modified by strain: $\nu_{j}\nu_{k}$

* invasiveness is primarily determined by strain, and modified by serotype: $\nu_{j}\nu_{k}$

* invasiveness differs between each combination of serotype and strain: $\nu_{j,k}$

To fit the model that invasiveness is determined by serotype indepedent of strain, the same approach is used as described in the other vignettes, using the serotype-only data:

```{r Fit Poisson model to serotype data}

s_pneumoniae_sweden_by_serotype_fit <- 
  progressionEstimation::fit_progression_rate_model(s_pneumoniae_sweden_by_serotype_data,
                                                    type_specific = TRUE,
                                                    location_adjustment = FALSE,
                                                    num_chains = 2,
                                                    num_iter = 1e4)

s_pneumoniae_sweden_serotype_output_df <-
  progressionEstimation::process_progression_rate_model_output(s_pneumoniae_strains_df,
                                                               s_pneumoniae_sweden_by_serotype_fit,
                                                               condense = FALSE)

```

To fit the model that invasiveness is determined by strain indepedent of serotype, this approach is modified to instead use the data in which the categorisation was defined as the strain (note that `subtype = "strain"` must be specified when processing the output, to ensure the invasiveness values correspond to strains, rather than serotypes:

```{r Fit Poisson model to strain data}

s_pneumoniae_sweden_by_strain_fit <- 
  progressionEstimation::fit_progression_rate_model(s_pneumoniae_sweden_by_strain_data,
                                                    type_specific = TRUE,
                                                    location_adjustment = FALSE,
                                                    num_chains = 2,
                                                    num_iter = 1e4)

s_pneumoniae_sweden_strain_output_df <-
  progressionEstimation::process_progression_rate_model_output(s_pneumoniae_strains_df,
                                                               s_pneumoniae_sweden_by_strain_fit,
                                                               subtype = "strain")

```

The next two models use the data containing information on both the strains and serotypes. To fit a model in which invasiveness is primarily determined by serotype, but modified by strain, we specify `strain_as_secondary_type = TRUE`:

```{r Fit Poisson model to serotype and strain data 1}

s_pneumoniae_sweden_by_serotype_then_strain_fit <- 
  progressionEstimation::fit_progression_rate_model(s_pneumoniae_sweden_by_serotype_and_strain_data,
                                                    type_specific = TRUE,
                                                    location_adjustment = FALSE,
                                                    strain_as_secondary_type = TRUE,
                                                    num_chains = 2,
                                                    num_iter = 1e4)

s_pneumoniae_sweden_by_serotype_then_strain_fit@model_name <- "serotype_then_strain_type_specific_poisson"

s_pneumoniae_sweden_by_serotype_then_strain_output_df <-
  progressionEstimation::process_progression_rate_model_output(s_pneumoniae_strains_df,
                                                            s_pneumoniae_sweden_by_serotype_then_strain_fit,
                                                               strain_as_secondary_type = TRUE)
```

The next model is fitted in the same way, except specifying `strain_as_primary_type = TRUE`:

```{r Fit Poisson model to serotype and strain data 2}

s_pneumoniae_sweden_by_strain_then_serotype_fit <- 
  progressionEstimation::fit_progression_rate_model(s_pneumoniae_sweden_by_serotype_and_strain_data,
                                                    type_specific = TRUE,
                                                    location_adjustment = FALSE,
                                                    strain_as_primary_type = TRUE,
                                                    num_chains = 2,
                                                    num_iter = 1e4)

s_pneumoniae_sweden_by_strain_then_serotype_fit@model_name <- "strain_then_serotype_type_specific_poisson"

s_pneumoniae_sweden_by_strain_then_serotype_output_df <-
  progressionEstimation::process_progression_rate_model_output(s_pneumoniae_strains_df,
                                                            s_pneumoniae_sweden_by_strain_then_serotype_fit,
                                                               strain_as_primary_type = TRUE)

```

The final model fit uses the combined type, defined by the serotype and strain, as a single subtype classification:

```{r Fit Poisson model to serotype and strain data 3}

s_pneumoniae_sweden_combined_strain_serotype_fit <- 
  progressionEstimation::fit_progression_rate_model(s_pneumoniae_sweden_combine_serotype_and_strain_data,
                                                    type_specific = TRUE,
                                                    location_adjustment = FALSE,
                                                    num_chains = 2,
                                                    num_iter = 1e4)

s_pneumoniae_sweden_combined_strain_serotype_fit@model_name <- "combined_serotype_and_strain_type_specific_poisson"

s_pneumoniae_sweden_combined_strain_serotype_output_df <-
  progressionEstimation::process_progression_rate_model_output(s_pneumoniae_strains_df,
                                                            s_pneumoniae_sweden_combined_strain_serotype_fit,
                                                            combined_strain_subtype = TRUE)

```

## Plotting the results

We can then plot the estimated progression rates when the population was divided by serotype only:

``` {r Plot progression rate estimates for serotypes}

progressionEstimation::plot_progression_rates(s_pneumoniae_sweden_serotype_output_df,
                                              unit_time = "year",
                                              type_name = "Serotypes")

```

``` {r Plot progression rate estimates for strains}

progressionEstimation::plot_progression_rates(s_pneumoniae_sweden_strain_output_df,
                                              subtype = "strain",
                                              unit_time = "year",
                                              type_name = "Strain")

```

``` {r Plot progression rate estimates for serotype modified by strain - plotted by serotype}

progressionEstimation::plot_progression_rates(s_pneumoniae_sweden_by_serotype_then_strain_output_df,
                                              unit_time = "year",
                                              type_name = "Serotype")

```

``` {r Plot progression rate estimates for serotype modified by strain - plotted by strain}

progressionEstimation::plot_progression_rates(s_pneumoniae_sweden_by_serotype_then_strain_output_df,
                                              subtype = "strain",
                                              unit_time = "year",
                                              type_name = "Strain")

```

``` {r Plot progression rate estimates for strain modified by serotype - plotted by strain}

progressionEstimation::plot_progression_rates(s_pneumoniae_sweden_by_strain_then_serotype_output_df,
                                              subtype = "strain",
                                              unit_time = "year",
                                              type_name = "Strain")

```

``` {r Plot progression rate estimates for strain modified by serotype - plotted by serotype}

progressionEstimation::plot_progression_rates(s_pneumoniae_sweden_by_strain_then_serotype_output_df,
                                              unit_time = "year",
                                              type_name = "Serotype")

```

``` {r Plot progression rate estimates for serotype_strain combinations}

progressionEstimation::plot_progression_rates(s_pneumoniae_sweden_combined_strain_serotype_output_df,
                                              subtype = "combined",
                                              unit_time = "year",
                                              type_name = "Serotype_strain combination")

```

## Run model comparisons

``` {r Compare models with LOO-CV}

progressionEstimation::compare_model_fits_with_loo(list(s_pneumoniae_sweden_by_serotype_fit,
                                                        s_pneumoniae_sweden_by_strain_fit,
                                                        s_pneumoniae_sweden_by_strain_then_serotype_fit,
                                 s_pneumoniae_sweden_by_serotype_then_strain_fit,
                                 s_pneumoniae_sweden_combined_strain_serotype_fit)) %>%
  kableExtra::kable()  %>%
  kableExtra::kable_styling(latex_options = "scale_down")

```
