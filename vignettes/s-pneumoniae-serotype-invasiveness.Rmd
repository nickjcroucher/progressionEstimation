---
title: "s-pneumoniae-serotype-invasiveness"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{s-pneumoniae-serotype-invasiveness}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 8,
  comment = "#>"
)
options(rmarkdown.html_vignette.check_title = FALSE)
```

```{r setup}
# Load dependencies
require(tidyverse)
require(magrittr)
require(rstan)
require(bridgesampling)
require(loo)
require(cowplot)
require(ggrepel)
require(xlsx)

# Load stan package
library(progressionEstimation)
pkgbuild::compile_dll()
roxygen2::roxygenize(package.dir = "..")

# Define serotype categories and palettes
vaccine_types <- list(
  "PCV7" = c("4","6B","9V","14","18C","19F","23F"),
  "PCV10" = c("4","6B","9V","14","18C","19F","23F","1","5","7F"),
  "PCV13" = c("4","6B","9V","14","18C","19F","23F","1","5","7F","6A","3","19A")
)

vaccine_colours <- c("No PCV" = "blue",
                     "PCV7" = "red",
                     "PCV10" = "orange",
                     "PCV13" = "coral2")

epi_colors <- c(
  "carriage" = "skyblue",
  "disease" = "cornflowerblue"
)

```

## Description and filtering of the dataset

The dataset used in this analysis is contained in the `S_pneumoniae_infant_serotype` object, which includes data from `r S_pneumoniae_infant_serotype %>% dplyr::select(study) %>% dplyr::n_distinct()` studies on `r S_pneumoniae_infant_serotype %>% dplyr::select(categorisation) %>% dplyr::n_distinct()` serotypes. The distribution of samples between each study can be plotted, if they are ranked by the mean number of carriage and disease isolates:

``` {r Plot distribution by study, include = FALSE}

studies_by_size <-
  S_pneumoniae_infant_serotype %>%
    group_by(study) %>%
    dplyr::mutate(total_count = sum(carriage)+sum(disease)) %>%
    dplyr::select(study,total_count) %>%
    dplyr::distinct() %>%
    dplyr::arrange(desc(total_count)) %>%
    dplyr::select(study) %>%
    dplyr::pull()

S_pneumoniae_infant_serotype %<>%
  dplyr::mutate(study = factor(study, levels = studies_by_size))

ggplot(S_pneumoniae_infant_serotype %>%
         tidyr::pivot_longer(c(carriage,disease),
                             names_to = "Sample type",
                             values_to = "count"),
       aes(x = study,
           y = count,
           colour = `Sample type`,
           fill = `Sample type`)) +
  geom_col() +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_fill_manual(values = epi_colors) +
  scale_colour_manual(values = epi_colors)

```

The total number of observations for each serotype can be similarly plotted:

``` {r Plot distribution by serotype, include = FALSE}

serotype_by_count <-
  S_pneumoniae_infant_serotype %>%
    group_by(categorisation) %>%
    dplyr::mutate(total_count = sum(carriage)+sum(disease)) %>%
    dplyr::select(categorisation,total_count) %>%
    dplyr::distinct() %>%
    dplyr::arrange(desc(total_count)) %>%
    dplyr::select(categorisation) %>%
    dplyr::pull()

S_pneumoniae_infant_serotype %<>%
  dplyr::mutate(categorisation = factor(categorisation, levels = serotype_by_count))

ggplot(S_pneumoniae_infant_serotype %>%
         tidyr::pivot_longer(c(carriage,disease),
                             names_to = "Sample type",
                             values_to = "count"),
       aes(x = categorisation,
           y = count,
           colour = `Sample type`,
           fill = `Sample type`)) +
  geom_col() +
  xlab("Serotype") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_fill_manual(values = epi_colors) +
  scale_colour_manual(values = epi_colors)

```

As many of these serotypes are rare, to facilitate model fitting, we exclude any serotype for which the maximum number of observations is below five:

``` {r Plot distribution by serotype in filtered dataset, include = FALSE}

threshold_count <- 5

filtered_S_pneumoniae_infant_serotype <-
  S_pneumoniae_infant_serotype %>%
    dplyr::group_by(categorisation) %>%
    dplyr::mutate(max_serotype_count = max(max(carriage),max(disease))) %>%
    dplyr::ungroup() %>%
    dplyr::filter(max_serotype_count >= threshold_count) %>%
    dplyr::select(-max_serotype_count)

filtered_S_pneumoniae_infant_serotype %<>%
    dplyr::mutate(categorisation = factor(categorisation,
                                          levels = serotype_by_count[serotype_by_count %in% unique(filtered_S_pneumoniae_infant_serotype$categorisation)]))

infant_serotype_invasiveness <- 
  progressionEstimation::process_input_data(filtered_S_pneumoniae_infant_serotype)

ggplot(filtered_S_pneumoniae_infant_serotype %>%
         tidyr::pivot_longer(c(carriage,disease),
                             names_to = "Sample type",
                             values_to = "count"),
       aes(x = categorisation,
           y = count,
           colour = `Sample type`,
           fill = `Sample type`)) +
  geom_col() +
  xlab("Serotype") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_fill_manual(values = epi_colors) +
  scale_colour_manual(values = epi_colors)

```

This filtered dataset comprises `r S_pneumoniae_infant_serotype %>% dplyr::select(categorisation) %>% dplyr::n_distinct()` serotypes.

## Fitting the statistical models

The null model, in which each serotyoe $j$ causes invasive disease at the same rate in each location $i$, can be fitted using a Poisson distribution of disease isolates (**null Poisson** model):

$$d_{i,j} \sim Pois(\nu\rho_{i,j}N_{i}t_{i})$$

``` {r Null Poisson model fit, include = FALSE}

n_chains <- 2
n_iter <- 1e5
n_core <- 2

null_poisson_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_serotype_invasiveness,
                                                    type_specific = FALSE,
                                                    location_adjustment = FALSE,
                                                    stat_model = "poisson",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core)

```

The null model can be fitted using a negative binomial distribution of disease isolates (**null negative binomial** model):

$$d_{i,j} \sim NegBin(\nu\rho_{i,j}N_{i}t_{i},\phi)$$

``` {r Null negative binomial model fit, include = FALSE}

null_negbin_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_serotype_invasiveness,
                                                    type_specific = FALSE,
                                                    location_adjustment = FALSE,
                                                    stat_model = "negbin",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core)

```

The Poisson model can be modified by allowing each serotype to have its own invasiveness, $\nu_{j}$ (**type-specific Poisson** model):

$$d_{i,j} \sim Pois(\nu_{j}\rho_{i,j}N_{i}t_{i})$$
``` {r Type-specific Poisson model fit, include = FALSE}

type_specific_poisson_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_serotype_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = FALSE,
                                                    stat_model = "poisson",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core)

```

The negative binomial model can be modified in the same way (**type-specific negative binomial** model):

$$d_{i,j} \sim NegBin(\nu_{j}\rho_{i,j}N_{i}t_{i},\phi)$$

``` {r Type-specific negative binomial model fit, include = FALSE}

type_specific_negbin_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_serotype_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = FALSE,
                                                    stat_model = "negbin",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core)

```

Alternatively, the Poisson model can be modified by allowing invasiveness to be adjusted between locations by a scale factor, $\delta_{i}$. In this model, all serotypes still have the same invasiveness (**adjusted Poisson** model):

$$d_{i,j} \sim Poisson(\delta_{i}\nu\rho_{i,j}N_{i}t_{i})$$

``` {r Adjusted Poisson model fit, include = FALSE}

adjusted_poisson_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_serotype_invasiveness,
                                                    type_specific = FALSE,
                                                    location_adjustment = TRUE,
                                                    stat_model = "poisson",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core)

```

The negative binomial model can again be modified in the same way (**adjusted negative binomial** model):

$$d_{i,j} \sim NegBin(\delta_{i}\nu\rho_{i,j}N_{i}t_{i},\phi)$$

``` {r Adjusted negative binomial model fit, include = FALSE}

adjusted_negbin_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_serotype_invasiveness,
                                                    type_specific = FALSE,
                                                    location_adjustment = TRUE,
                                                    stat_model = "negbin",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core)

```


Both modifications can be combined in adjusted type-specific model fits. This can be used with the Poisson model of disease isolate counts (**adjusted type-specific Poisson** model):

$$d_{i,j} \sim Poisson(\delta_{i}\nu_{j}\rho_{i,j}N_{i}t_{i})$$

``` {r Adjusted type-specific Poisson model fit, include = FALSE}

adjusted_type_specific_poisson_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_serotype_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    stat_model = "poisson",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core)

```

This can also be used with the negative binomial model (**adjusted type-specific negative binomial** model):

$$d_{i,j} \sim NegBin(\delta_{i}\nu_{j}\rho_{i,j}N_{i}t_{i},\phi)$$

``` {r Adjusted type-specific negative binomial model fit, include = FALSE}

adjusted_type_specific_negbin_fit <- 
  progressionEstimation::fit_progression_rate_model(infant_serotype_invasiveness,
                                                    type_specific = TRUE,
                                                    location_adjustment = TRUE,
                                                    stat_model = "negbin",
                                                    num_chains = n_chains,
                                                    num_iter = n_iter,
                                                    num_cores = n_core)

```

To check the models have fitted correctly, we can plot the $\hat{R}$ values across MCMCs:

``` {r Plot r hat values}

fit_list <- list(null_poisson_fit,
                 null_negbin_fit,
                 type_specific_poisson_fit,
                 type_specific_negbin_fit,
                 adjusted_poisson_fit,
                 adjusted_negbin_fit,
                 adjusted_type_specific_poisson_fit,
                 adjusted_type_specific_negbin_fit)

rhat_plots <- lapply(fit_list, plot, plotfun = "rhat", binwidth = 0.00005)

cowplot::plot_grid(plotlist = rhat_plots, ncol = 4, nrow = 2, labels = "AUTO")

```

Convergence can also be checked using trace plots of the log likelihood values:

``` {r Plot log likelihood traces}

plot_lp <- function(fit) {
  pl <- rstan::traceplot(fit, pars = "lp__")
  no_leg_pl <- pl + theme(legend.position = "none")
  return(no_leg_pl)
}

trace_plots <- lapply(fit_list, plot_lp)

cowplot::plot_grid(plotlist = trace_plots, ncol = 4, nrow = 2, labels = "AUTO")

```

## Compare model observations and predictions

For each model, the output can be processed, and the observations plotted against each model's predictions.

``` {r Process model outputs and plot predictions, fig.height = 12}

model_outputs <- lapply(fit_list,
                        progressionEstimation::process_progression_rate_model_output,
                        filtered_S_pneumoniae_infant_serotype)

prediction_plots <- lapply(model_outputs, progressionEstimation::plot_case_carrier_predictions, legend = FALSE)

no_leg_plot <- cowplot::plot_grid(plotlist = prediction_plots, ncol = 1, nrow = 8, labels = "AUTO")

prediction_plot_legend <- progressionEstimation::plot_case_carrier_predictions(model_outputs[[1]], just_legend = TRUE)

cowplot::plot_grid(no_leg_plot, prediction_plot_legend, ncol = 1, rel_heights = c(0.9,0.1))

```

## Run model comparison with leave-one-out cross-validation

The model likelihoods can be compared using leave-one-out cross-validation:

``` {r Comparison with LOO-CV, include = FALSE}

loo_comparison <- progressionEstimation::compare_model_fits_with_loo(fit_list)
loo_comparison %>%
  kableExtra::kable()  %>%
  kableExtra::kable_styling(latex_options = "scale_down")

```

## Run model comparison with Bayes factors

The models can also be compared with Bayes factors:

``` {r Comparison with BF, include = FALSE}

bf_comparison <- progressionEstimation::compare_model_fits_with_bf(fit_list, num_iter = n_iter)
bf_comparison %>%
  kableExtra::kable()  %>%
  kableExtra::kable_styling(latex_options = "scale_down")

```

## Plot serotype invasiveness

``` {r Plot invasiveness estimates from best-fitting model}

invasiveness_plot <-
  progressionEstimation::plot_progression_rates(model_outputs[[7]],
                                                unit_time = "year",
                                                type_name = "Serotype")

```

## Plot study-specific scale factors

``` {r Plot study-specific scale factor estimates from best-fitting model}

scale_factor_plot <-
  progressionEstimation::plot_study_scale_factors(model_outputs[[7]])

```

## Comparison 
